<!DOCTYPE html>
<html>
<head>
    <title>CA Trust Model System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vis-network/9.1.6/standalone/umd/vis-network.min.js"></script>    <style>
        body { margin: 0; padding: 20px; font-family: Arial, sans-serif; background: #f0f2f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .panel { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        #network {
            height: 600px;
            min-width: 400px;
            width: 100%;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }        .form-group { margin-bottom: 10px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        select, input { width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; }
        button { width: 100%; background: #4CAF50; color: white; padding: 10px; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #45a049; }
        #trustResult { margin-top: 10px; padding: 10px; border-radius: 4px; }
        .success { background: #e8f5e9; color: #2e7d32; }
        .error { background: #ffebee; color: #c62828; }
    </style>
</head>
<body>
    <div class="container">
        <div class="controls">
            <div class="panel">
                <h2>Model Settings</h2>
                <div class="form-group">
                    <label>Trust Model Type</label>
                    <select id="modelType">
                        <option value="strict">Strict Hierarchy</option>
                        <option value="networked">Networked Trust</option>
                        <option value="browser">Web Browser Model</option>
                        <option value="pgp">PGP Web of Trust</option>
                    </select>
                </div>
                <button onclick="createModel()">Initialize Model</button>
            </div>

            <div class="panel">
                <h2>Add Node</h2>
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="nodeName" placeholder="Enter node name">
                    <label>Node Type</label>
                    <select id="nodeType"></select>
                    <label>Trust Level (PGP only)</label>
                    <select id="trustLevel" disabled>
                        <option value="Complete">Complete Trust</option>
                        <option value="Implicit">Implicit Trust</option>
                        <option value="Partial">Partial Trust</option>
                        <option value="Marginal">Marginal Trust</option>
                        <option value="Invalid">Invalid Trust</option>
                    </select>
                </div>
                <button onclick="addNode()">Add Node</button>
            </div>

            <div class="panel">
                <h2>Add Trust Relationship</h2>
                <div class="form-group">
                    <label>From</label>
                    <select id="sourceNode"></select>
                    <label>To</label>
                    <select id="targetNode"></select>
                </div>
                <button onclick="addEdge()">Add Relationship</button>
            </div>

            <div class="panel">
                <h2>Check Trust</h2>
                <div class="form-group">
                    <label>From</label>
                    <select id="checkSource"></select>
                    <label>To</label>
                    <select id="checkTarget"></select>
                </div>
                <button onclick="checkTrust()">Verify Trust</button>
                <div id="trustResult"></div>
            </div>
        </div>

        <div id="network"></div>
    </div>

    <script>
        let network = null;
        let nodes = new vis.DataSet();
        let edges = new vis.DataSet();
    
        const nodeColors = {
            'Root CA': '#3b82f6',
            'Super Root CA': '#7c3aed',
            'Intermediate CA': '#10b981',
            'End Entity': '#6b7280',
            'PGP User': '#f59e0b'
        };
    
        const trustLevelColors = {
            'Complete': '#22c55e',
            'Implicit': '#3b82f6',
            'Partial': '#f59e0b',
            'Marginal': '#d97706',
            'Invalid': '#ef4444'
        };
    
        const nodeTypes = {
            strict: ['Root CA', 'Intermediate CA', 'End Entity'],
            networked: ['Root CA', 'Super Root CA'],
            browser: ['Root CA', 'Intermediate CA', 'End Entity'],
            pgp: ['PGP User']
        };
    
        function getNodeColor(nodeType, trustLevel) {
            return trustLevel ? trustLevelColors[trustLevel] : nodeColors[nodeType];
        }
    
        function createNode(name, nodeType, trustLevel) {
            return {
                id: name,
                label: name,
                title: `${nodeType}${trustLevel ? `\nTrust: ${trustLevel}` : ''}`,
                color: {
                    background: getNodeColor(nodeType, trustLevel),
                    border: '#1f2937',
                    highlight: { background: '#93c5fd', border: '#1f2937' }
                },
                font: { color: '#ffffff' }
            };
        }
    
        function updateNodeTypeOptions() {
            const modelType = document.getElementById('modelType').value;
            const nodeTypeSelect = document.getElementById('nodeType');
            const trustLevelSelect = document.getElementById('trustLevel');
            
            nodeTypeSelect.innerHTML = nodeTypes[modelType]
                .map(type => `<option value="${type}">${type}</option>`)
                .join('');
                
            trustLevelSelect.disabled = modelType !== 'pgp';
            updateLayout();
        }
    
        function updateLayout() {
            const modelType = document.getElementById('modelType').value;
            const options = {
                physics: {
                    enabled: modelType === 'pgp',
                    hierarchicalRepulsion: {
                        nodeDistance: 150,
                        springLength: 200,
                        springConstant: 0.01,
                        damping: 0.09
                    },
                    stabilization: {
                        iterations: 50,
                        updateInterval: 25
                    }
                },
                layout: {
                    hierarchical: {
                        enabled: modelType !== 'pgp',
                        direction: 'UD',
                        sortMethod: 'directed',
                        nodeSpacing: 150,
                        levelSeparation: 150,
                        treeSpacing: 200
                    }
                },
                nodes: {
                    shape: 'box',
                    margin: 10,
                    font: { size: 14, face: 'system-ui' },
                    borderWidth: 2,
                    shadow: true
                },
                edges: {
                    arrows: { to: { enabled: true, scaleFactor: 1 }},
                    color: { color: '#64748b', highlight: '#2563eb' },
                    width: 2,
                    smooth: {
                        type: modelType === 'pgp' ? 'dynamic' : 'cubicBezier',
                        roundness: 0.5
                    }
                }
            };
            
            if (network) {
                network.setOptions(options);
                network.stabilize();
            } else {
                const container = document.getElementById('network');
                network = new vis.Network(container, { nodes, edges }, options);
            }
        }
    
        async function createModel() {
            const modelType = document.getElementById('modelType').value;
            try {
                const response = await fetch('/api/create_model', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: modelType })
                });
                const data = await response.json();
                if (data.success) {
                    if (network) {
                        network.destroy();
                        network = null;
                    }
                    nodes.clear();
                    edges.clear();
                    updateNodeTypeOptions();
                    initNetwork(); // Reinitialize the network
                    document.getElementById('trustResult').textContent = '';
                    document.getElementById('trustResult').className = '';
                }
            } catch (error) {
                console.error('Error creating model:', error);
            }
        }
    
        async function addNode() {
            const modelType = document.getElementById('modelType').value;
            const name = document.getElementById('nodeName').value;
            const nodeType = document.getElementById('nodeType').value;
            const trustLevel = modelType === 'pgp' ? 
                document.getElementById('trustLevel').value : undefined;
            
            if (!name) {
                alert('Please enter a node name');
                return;
            }
    
            try {
                const response = await fetch('/api/add_node', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model_type: modelType,
                        name: name,
                        node_type: nodeType,
                        trust_level: trustLevel
                    })
                });
                const data = await response.json();
                if (data.success) {
                    nodes.add(createNode(name, nodeType, trustLevel));
                    updateNodeSelectors();
                    document.getElementById('nodeName').value = '';
                }
            } catch (error) {
                console.error('Error adding node:', error);
            }
        }
    
        async function addEdge() {
            const modelType = document.getElementById('modelType').value;
            const source = document.getElementById('sourceNode').value;
            const target = document.getElementById('targetNode').value;
    
            if (source === target) {
                alert('Cannot create self-referential trust relationship');
                return;
            }
    
            try {
                const response = await fetch('/api/add_edge', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model_type: modelType,
                        source: source,
                        target: target
                    })
                });
                const data = await response.json();
                if (data.success) {
                    edges.add({
                        from: source,
                        to: target,
                        arrows: 'to'
                    });
                } else {
                    alert('Invalid trust relationship for the selected model type');
                }
            } catch (error) {
                console.error('Error adding edge:', error);
            }
        }
    
        async function checkTrust() {
            const modelType = document.getElementById('modelType').value;
            const source = document.getElementById('checkSource').value;
            const target = document.getElementById('checkTarget').value;
    
            try {
                const response = await fetch('/api/check_trust', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model_type: modelType,
                        source: source,
                        target: target
                    })
                });
                const data = await response.json();
                const resultDiv = document.getElementById('trustResult');
                resultDiv.className = data.trusted ? 'success' : 'error';
                
                if (data.trusted) {
                    if (data.level) {
                        resultDiv.textContent = `Trust Verified: ${data.level} trust level`;
                    } else {
                        resultDiv.textContent = `Trust Verified: Chain length ${data.chain_length}`;
                        highlightPath(data.path);
                    }
                } else {
                    resultDiv.textContent = `Trust Failed: ${data.reason}`;
                }
            } catch (error) {
                console.error('Error checking trust:', error);
            }
        }
    
        function highlightPath(path) {
            if (!path) return;
            
            edges.forEach(edge => {
                edge.color = undefined;
                edges.update(edge);
            });
            
            for (let i = 0; i < path.length - 1; i++) {
                const edge = edges.get().find(e => 
                    e.from === path[i] && e.to === path[i + 1]
                );
                if (edge) {
                    edge.color = {
                        color: '#22c55e',
                        highlight: '#22c55e'
                    };
                    edges.update(edge);
                }
            }
        }
    
        function updateNodeSelectors() {
            const nodeList = nodes.get().map(node => node.id);
            ['sourceNode', 'targetNode', 'checkSource', 'checkTarget'].forEach(selectId => {
                const select = document.getElementById(selectId);
                select.innerHTML = nodeList
                    .map(node => `<option value="${node}">${node}</option>`)
                    .join('');
            });
        }
        function initNetwork() {
            const container = document.getElementById('network');
            const data = {
                nodes: nodes,
                edges: edges
            };
            const options = {
                physics: {
                    enabled: true,
                    hierarchicalRepulsion: {
                        nodeDistance: 150,
                        springLength: 200,
                        springConstant: 0.01,
                        damping: 0.09
                    },
                    stabilization: {
                        iterations: 50,
                        updateInterval: 25
                    }
                },
                layout: {
                    hierarchical: {
                        enabled: true,
                        direction: 'UD',
                        sortMethod: 'directed',
                        nodeSpacing: 150,
                        levelSeparation: 150,
                        treeSpacing: 200
                    }
                },
                nodes: {
                    shape: 'box',
                    margin: 10,
                    font: { size: 14, face: 'system-ui' },
                    borderWidth: 2,
                    shadow: true
                },
                edges: {
                    arrows: { to: { enabled: true, scaleFactor: 1 }},
                    color: { color: '#64748b', highlight: '#2563eb' },
                    width: 2,
                    smooth: {
                        type: 'cubicBezier',
                        roundness: 0.5
                    }
                }
            };
            
            network = new vis.Network(container, data, options);
        }
    
        document.getElementById('modelType').addEventListener('change', updateNodeTypeOptions);
        document.addEventListener('DOMContentLoaded', () => {
            updateNodeTypeOptions();
            initNetwork();
        });
    </script>
</body>
</html>